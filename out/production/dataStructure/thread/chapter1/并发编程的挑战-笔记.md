###1 多线程与单线程的选择
在运行的任务，耗费时常不是很大的情况下，不需要使用多线程，普通的单线程串行就可以了。
因为多线程在创建线程，线程之间切换等时候都有开销。所以在在程序耗费时间少的情况下，
不要盲目的使用多线程。
###2 如何减少多线程上下文切换
减少上下文切换的方法有无锁并发编程、CAS算法、使用最少线程和使用协程。

- 无锁并发编程。多线程竞争锁时，会引起上下文切换，所以多线程处理数据时，可以用一
些办法来避免使用锁，如将数据的ID按照Hash算法取模分段，不同的线程处理不同段的数据。
- CAS算法。Java的Atomic包使用CAS算法来更新数据，而不需要加锁。
- 使用最少线程。避免创建不需要的线程，比如任务很少，但是创建了很多线程来处理，这
样会造成大量线程都处于等待状态。
- 协程：在单线程里实现多任务的调度，并在单线程里维持多个任务间的切换。
###3 死锁
锁是一个非常有用的工具，运用场景特别多，但是他也会出一些问题，最出名的就是死锁现象。
```java
public class DeadLockDemo {
private static String A = "A";
private static String B = "B";
public static void main(String[] args) {
new DeadLockDemo().deadLock();
}
private void deadLock() {
    Thread t1 = new Thread(new Runnable() {
        @Override
        publicvoid run() {
            synchronized (A) {
                try { 
                    Thread.currentThread().sleep(2000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }  
                synchronized (B) {
                System.out.println("1");
                }
            }
        }
    });
    Thread t2 = new Thread(new Runnable() {
        @Override
        publicvoid run() {
            synchronized (B) {
                synchronized (A) {
                    System.out.println("2");
                }
            }
        }
    });
    t1.start();
    t2.start();
}
}
```
上面的代码展示的是死锁的情况，显示业务中肯定不会这样写代码，但是，在一些更加复杂的
场景中，可能也会出现一些死锁现象。
比如：t1线程拿到锁之后，因为一些异常情况没有释放锁（死循环等）。或者t1拿到数据库锁之后，
释放锁的时候抛出了异常，没释放掉。
####避免死锁的几个方案
1. 避免一个线程同时获得好几个锁；
2. 避免一个线程在锁内同时占用多个资源，尽量保证每个锁只占用一个资源；
3. 尝试使用定时锁，使用Lock.tryLock(timeout)来替代使用内部锁机制；
4. 对于数据库锁，加锁和解锁必须在一个数据库连接里，否则会出现解锁失败的情况。
###资源限制的挑战
####1.什么是资源挑战
资源限制是指在进行并发编程时，程序的执行速度受限于计算机硬件资源或软件资源。
例如，服务器的带宽只有2Mb/s，某个资源的下载速度是1Mb/s每秒，系统启动10个线程下载资
源，下载速度不会变成10Mb/s，所以在进行并发编程时，要考虑这些资源的限制。硬件资源限
制有带宽的上传/下载速度、硬盘读写速度和CPU的处理速度。软件资源限制有数据库的连接
数和socket连接数等。
####2.资源限制引发的问题
在并发编程中，将代码执行速度加快的原则是将代码中串行执行的部分变成并发执行，
但是如果将某段串行的代码并发执行，因为受限于资源，仍然在串行执行，这时候程序不仅不
会加快执行，反而会更慢，因为增加了上下文切换和资源调度的时间。例如，之前看到一段程
序使用多线程在办公网并发地下载和处理数据时，导致CPU利用率达到100%，几个小时都不
能运行完成任务，后来修改成单线程，一个小时就执行完成了。
####3.如何解决资源限制的问题
对于硬件资源限制，可以考虑使用集群并行执行程序。既然单机的资源有限制，那么就让
程序在多机上运行。比如使用ODPS、Hadoop或者自己搭建服务器集群，不同的机器处理不同
的数据。可以通过“数据ID%机器数”，计算得到一个机器编号，然后由对应编号的机器处理这
笔数据。
对于软件资源限制，可以考虑使用资源池将资源复用。比如使用连接池将数据库和Socket
连接复用，或者在调用对方webservice接口获取数据时，只建立一个连接。
####4.0在资源限制情况下进行并发编程
如何在资源限制的情况下，让程序执行得更快呢？方法就是，根据不同的资源限制调整
程序的并发度，比如下载文件程序依赖于两个资源——带宽和硬盘读写速度。有数据库操作
时，涉及数据库连接数，如果SQL语句执行非常快，而线程的数量比数据库连接数大很多，则
某些线程会被阻塞，等待数据库连接。